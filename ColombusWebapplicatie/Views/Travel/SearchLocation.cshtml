@model IList<ColombusWebapplicatie.Models.Travel.LocationDetails>

@{
    ViewBag.Title = "Locaties Toevoegen";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles
{
    <style>
    #map-canvas
    {
        margin: 1em 0px;
    }
    </style>
}

@section Scripts
{
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    @if (Model != null && Model.Count > 0)
    {
        <script>
    function foundResults() {
        var markers = [];
        var infoWindows = [];
        var mapCanvas = document.getElementById('map-canvas');
        var mapOptions = {
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        var map = new google.maps.Map(mapCanvas, mapOptions);
        var markerId = 0;
        var latLngBounds = new google.maps.LatLngBounds();
        @foreach (var locationDetails in Model)
            {
            <text>
                infoWindows[markerId] = new google.maps.InfoWindow({
                    content: '<h4>@locationDetails.Name</h4>'
                    +'@(locationDetails.Address.IsEmpty() == false ? Html.Raw("<div>" + locationDetails.Address + "</div>") : Html.Raw(""))'
                    +'@(locationDetails.PhoneNumber.IsEmpty() == false ? Html.Raw("<div>" + locationDetails.PhoneNumber + "</div>") : Html.Raw(""))'
                    +'@Html.Raw(Html.ActionLink("Locatie toevoegen", "ViewLocation", new { travelID = ViewBag.TravelID, placeID = locationDetails.PlaceID }))'
                });
                markers[markerId] = new google.maps.Marker({
                    id: markerId,
                    position: new google.maps.LatLng(@locationDetails.Coordinates.Latitude, @locationDetails.Coordinates.Longitude),
                    title: "@Html.Raw(locationDetails.Name)"
                });
                markers[markerId].setMap(map);
                latLngBounds.extend(markers[markerId].position);
                google.maps.event.addListener(markers[markerId], 'click', function() {
                    infoWindows[this.id].open(map,markers[this.id]);
                });
                markerId++;
            </text>
            }
        map.setCenter(latLngBounds.getCenter());
        map.fitBounds(latLngBounds);
    }
    google.maps.event.addDomListener(window, 'load', foundResults);
        </script>
    }
    else
    {
        <script>
            function initializeSearch() {
                var marker = null;
                var myLatlng = new google.maps.LatLng(0, 0);
                var mapOptions = {
                    zoom: 1,
                    center: myLatlng
                }
                var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
                google.maps.event.addListener(map, "click", function (event) {
                    if (marker != null) {
                        marker.setMap(null);
                    }
                    marker = new google.maps.Marker({
                        position: event.latLng,
                        draggable: true,
                        map: map
                    });
                    document.getElementById("lat").value = marker.getPosition().lat();
                    document.getElementById("lng").value = marker.getPosition().lng();
                });
            }
            google.maps.event.addDomListener(window, 'load', initializeSearch);
        </script>
    }
}

<div class="white-block">
    <div class="container">
        <h2>@ViewBag.Title</h2>
        @using(Html.BeginForm("ShowFoundLocation", "Travel", FormMethod.Post, new { travelID = ViewBag.TravelID })) {
            @Html.Hidden("lat")
            @Html.Hidden("lng")
            @Html.Hidden("travelID", null, new { travelID = ViewBag.TravelID })
            @Html.TextBox("query")
            <input class="button orange" type="submit" name="search" value="Zoeken">
        }
    </div>
    <div id="map-canvas"></div>
    <div class="container">
        @if(Model != null && Model.Count > 0) {
            <table cellspacing="0" cellpadding="0" id="travels">
                @foreach(var result in Model) {
                    <tr>
                        <td>
                            @result.Name <br />
                            @result.Address
                        </td>
                        <td>@Html.ActionLink("+", "ViewLocation", new { travelID = ViewBag.TravelID, placeID = result.PlaceID })</td>
                    </tr>
                }
            </table>
        }
    </div>
</div>
